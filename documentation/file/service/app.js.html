<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">service/app.js | rsp-be</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Backend part of Rock Scissors Paper game"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="rsp-be"><meta property="twitter:description" content="Backend part of Rock Scissors Paper game"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">service/app.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const express = require(&apos;express&apos;);
const cors = require(&apos;cors&apos;);
const bodyParser = require(&apos;body-parser&apos;);

const LoggerService = require(&apos;./logger&apos;);
const StaticController = require(&apos;../controller/static&apos;);
const UserController = require(&apos;../controller/user&apos;);
const GameController = require(&apos;../controller/game&apos;);
const GameService = require(&apos;./game&apos;);
const UserService = require(&apos;./user&apos;);
const StaticService = require(&apos;./static&apos;);

/**
 * App Service
 */
class AppService {

  /**
   * Main init method
   */
  init() {

    this.initConfig();
    this.initLogger();
    this.initServer();
    this.initService();
  }

  /**
   * Initialize config
   */
  initConfig() {

    this.env = process.env.NODE_ENV || &apos;production&apos;;

    this.config = require(&apos;../config/&apos; + this.env);
  }

  /**
   * Initialize logger
   */
  initLogger() {

    this.logger = new LoggerService(this);
  }

  /**
   * Initialize server
   */
  initServer() {

    this.server = express();

    this.server.use(cors());
    this.server.use(bodyParser.json());

    this.initRouting();

    this.server.listen(this.config.port, () =&gt;
      this.logger.info(&apos;Listening on port 3000&apos;));
  }

  /**
   * Initialize routing
   */
  initRouting() {

    new StaticController(this).init();
    new UserController(this).init();
    new GameController(this).init();
  }

  /**
   * Initialize services
   */
  initService() {

    this.gameService = new GameService(this);
    this.userService = new UserService(this);
    this.staticService = new StaticService(this);
  }

  /**
   * Auth middleware
   *
   * @param {Object} req Express request object
   * @param {Object} res Express response object
   *
   * @returns {Promise}
   */
  checkAuth(req, res) {

    return new Promise((resolve) =&gt; {

      const session = req.headers.authorization;

      if (!session || !this.userService.users[session]) {

        const err = new Error(&apos;User Not Found: &apos; + session);

        this.logger.error(err);

        return this.apiError(res, err);
      }

      resolve();
    });
  }

  /**
   * Main response handler
   *
   * @param {Object} res Express response object
   * @param {Object} promise response promise
   */
  apiResponse(res, promise) {

    promise
      .then((result) =&gt; this.apiSuccess(res, result))
      .catch((err) =&gt; this.apiError(res, err));
  }

  /**
   * On success response handler
   *
   * @param {Object} res Express response object
   * @param {Object} result Api result response
   */
  apiSuccess(res, result) {

    res.json({
      success: true,
      data: result
    });
  }

  /**
   * On error response handler
   *
   * @param {Object} res Express response object
   * @param {Error} err Error object
   */
  apiError(res, err) {

    res.status(500).json({
      success: false,
      message: this.config.apiExposeError ? err.message : &apos;API Error&apos;
    });
  }
}

module.exports = AppService;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
